blueprint:
  name: "IntegraSoft Shadow-PV v1.02 (Ghost Export PRO)"
  description: >
    ðŸš€ AUTOMATYKA HYBRYDOWA: IntegraSoft Shadow-PV v1.02 ðŸš€
    
    HISTORIA WERSJI:
    v1.02: Wprowadzenie logiki PRO. Sumowanie zyskÃ³w z dachu (PV) oraz mikroinwerterÃ³w (GEN).
           Dynamiczne dodawanie sumarycznego zuÅ¼ycia domu (Load + Grid-CT) do limitu eksportu.
           Zmiana mnoÅ¼nika na pole wprowadzane rÄ™cznie z dokÅ‚adnoÅ›ciÄ… 0.01 (max 2.50).
    v1.01: ZastÄ…pienie zewnÄ™trznej encji sÅ‚oÅ„ca wbudowanÄ…, twardÄ… matrycÄ… 12-miesiÄ™cznÄ….
           Kod w 100% niezaleÅ¼ny od zewnÄ™trznych usÅ‚ug pogodowych.
           Dodano url repozytorium do szybkiego importu.
    v1.00: Inicjalna logika maskowania eksportu (Efekt pustego domu).
    
    JAK UÅ»YWAÄ†:
    1. Wybierz Profil zgodny z resztÄ… instalacji.
    2. Wpisz ZgÅ‚oszonÄ… Moc PV do OSD (np. 6000 W).
    3. Wpisz MnoÅ¼nik AgresywnoÅ›ci (np. 1.50).
  
  source_url: https://github.com/zxvxv/export/blob/main/export.yaml
  
  domain: automation
  input:
    # ==========================================
    # 1. KONFIGURACJA GÅÃ“WNA
    # ==========================================
    in_dev_prefix:
      name: "1. ðŸ”¹ Prefiks UrzÄ…dzenia"
      default: "deye_inverter"

    in_standard_profile:
      name: "2. ðŸ“š Standard Integracji (Profil)"
      default: "lewa_reka"
      selector:
        select:
          options:
            - { label: "Lewa-Reka (DomyÅ›lny)", value: "lewa_reka" }
            - { label: "OZE4HOME (ESP32)", value: "oze4home" }
            - { label: "Dashboard / Sunsynk", value: "dashboard" }
            - { label: "SUN-12K (Local/Time) - Solarman", value: "sun12k" }

    # ==========================================
    # 2. PARAMETRY SHADOW-PV (GHOST EXPORT)
    # ==========================================
    in_p_max:
      name: "3. ðŸ”´ ZgÅ‚oszona moc instalacji PV (Waty)"
      description: "Twardy sufit. System nigdy nie wypchnie do sieci wiÄ™cej niÅ¼ ta wartoÅ›Ä‡, bez wzglÄ™du na sÅ‚oÅ„ce i ustawienia."
      default: 6000
      selector: { number: { min: 1000, max: 50000, mode: box, unit_of_measurement: "W" } }

    in_multiplier:
      name: "4. ðŸš€ MnoÅ¼nik AgresywnoÅ›ci (Ghost Factor)"
      description: "Jak bardzo podbijamy produkcjÄ™? (Zakres: 1.00 - 2.50). Np. 1.50 oznacza eksport 150% realnej produkcji sÅ‚onecznej."
      default: 1.50
      selector: { number: { min: 1.00, max: 2.50, step: 0.01, mode: box } }

mode: restart

variables:
  # Konfiguracja bazowa
  raw_prefix: !input in_dev_prefix
  prefix: "{{ raw_prefix | lower }}"
  profile: !input in_standard_profile
  
  # Parametry aplikacji
  p_max: !input in_p_max
  multiplier: !input in_multiplier
  
  # ==========================================================
  # BEZPOÅšREDNIE MAPOWANIE ENCJI (PEÅNY FORMAT DLA 4 PROFILI)
  # ==========================================================
  
  # Archiwum encji "Lewa RÄ™ka":
  # - Aktualne PV: sensor.deye_inverter_pv_power
  # - Mikroinwertery (GEN): sensor.deye_inverter_generator_power_total
  # - ZuÅ¼ycie dom (Load): sensor.deye_inverter_load_power
  # - Grid (Inverter): sensor.deye_inverter_grid_power
  # - ZewnÄ™trzne CT: sensor.deye_inverter_external_ct_power
  # - Max Sell: number.deye_inverter_max_sell_power
  # - Switch Sell: switch.deye_inverter_solar_sell

  pv_power_ent: >
    {% if profile == 'oze4home' %} sensor.{{ prefix }}_pv_power
    {% elif profile == 'dashboard' %} sensor.{{ prefix }}_pv_power
    {% elif profile == 'sun12k' %} sensor.{{ prefix }}_dc_power_total
    {% else %} sensor.{{ prefix }}_pv_power
    {% endif %}

  gen_power_ent: >
    {% if profile == 'oze4home' %} sensor.{{ prefix }}_generator_power_total
    {% elif profile == 'dashboard' %} sensor.{{ prefix }}_generator_power_total
    {% elif profile == 'sun12k' %} sensor.{{ prefix }}_gen_power_total
    {% else %} sensor.{{ prefix }}_generator_power_total
    {% endif %}

  load_power_ent: >
    {% if profile == 'oze4home' %} sensor.{{ prefix }}_load_power
    {% elif profile == 'dashboard' %} sensor.{{ prefix }}_load_power
    {% elif profile == 'sun12k' %} sensor.{{ prefix }}_load_power
    {% else %} sensor.{{ prefix }}_load_power
    {% endif %}

  grid_power_ent: >
    {% if profile == 'oze4home' %} sensor.{{ prefix }}_grid_power
    {% elif profile == 'dashboard' %} sensor.{{ prefix }}_grid_power
    {% elif profile == 'sun12k' %} sensor.{{ prefix }}_grid_power
    {% else %} sensor.{{ prefix }}_grid_power
    {% endif %}

  ct_power_ent: >
    {% if profile == 'oze4home' %} sensor.{{ prefix }}_external_ct_power
    {% elif profile == 'dashboard' %} sensor.{{ prefix }}_external_ct_power
    {% elif profile == 'sun12k' %} sensor.{{ prefix }}_external_ct_power
    {% else %} sensor.{{ prefix }}_external_ct_power
    {% endif %}

  max_sell_ent: >
    {% if profile == 'oze4home' %} number.{{ prefix }}_max_sell_power
    {% elif profile == 'dashboard' %} number.{{ prefix }}_max_sell_power
    {% elif profile == 'sun12k' %} number.{{ prefix }}_max_sell_power
    {% else %} number.{{ prefix }}_max_sell_power
    {% endif %}

  solar_sell_switch: >
    {% if profile == 'oze4home' %} switch.{{ prefix }}_solar_sell
    {% elif profile == 'dashboard' %} switch.{{ prefix }}_solar_sell
    {% elif profile == 'sun12k' %} switch.{{ prefix }}_solar_sell
    {% else %} switch.{{ prefix }}_solar_sell
    {% endif %}

  # ==========================================================
  # MATEMATYKA GHOST-EXPORT I TWARDA BAZA GODZINOWA OSD
  # ==========================================================
  
  # 1. Odczyt produkcji PV (Dach + Mikroinwertery)
  pv_val: "{{ states(pv_power_ent) | float(0) }}"
  gen_val: "{{ states(gen_power_ent) | float(0) }}"
  total_pv: "{{ pv_val + gen_val }}"
  
  # 2. Odczyt zuÅ¼ycia domu (Zapas na utrzymanie eksportu)
  # Obliczamy rÃ³Å¼nicÄ™ miÄ™dzy tym co falownik wystawia na Grid, a tym co wychodzi przez CT.
  load_val: "{{ states(load_power_ent) | float(0) }}"
  grid_val: "{{ states(grid_power_ent) | float(0) }}"
  ct_val: "{{ states(ct_power_ent) | float(0) }}"
  home_on_grid: "{{ grid_val - ct_val }}"
  total_home_load: "{{ load_val + (home_on_grid if home_on_grid > 0 else 0) }}"

  # 3. Twarda matryca godzinowa (Bezpiecznik Astronomiczny OSD)
  is_safe_time: >
    {% set m = now().month %}
    {% set t = now().strftime('%H:%M') %}
    {% if m == 1 %}{{ '08:00' <= t <= '15:30' }}
    {% elif m == 2 %}{{ '07:15' <= t <= '16:30' }}
    {% elif m == 3 %}{{ '06:15' <= t <= '17:30' }}
    {% elif m == 4 %}{{ '06:00' <= t <= '19:30' }}
    {% elif m == 5 %}{{ '05:00' <= t <= '20:30' }}
    {% elif m == 6 %}{{ '04:30' <= t <= '21:00' }}
    {% elif m == 7 %}{{ '04:45' <= t <= '20:45' }}
    {% elif m == 8 %}{{ '05:30' <= t <= '20:00' }}
    {% elif m == 9 %}{{ '06:15' <= t <= '19:00' }}
    {% elif m == 10 %}{{ '07:00' <= t <= '17:30' }}
    {% elif m == 11 %}{{ '07:15' <= t <= '15:45' }}
    {% elif m == 12 %}{{ '08:00' <= t <= '15:00' }}
    {% else %}false{% endif %}
  
  # 4. Wyliczenie docelowego limitu dla falownika (SÅ‚oÅ„ce * mnoÅ¼nik + Dom)
  calculated_target: "{{ ((total_pv * (multiplier | float)) + total_home_load) | int }}"
  
  # 5. Zastosowanie "szklanego sufitu" (P_MAX zgÅ‚oszone do energetyki + dom)
  # Sufit pozwala inwerterowi na max eksport (p_max) ORAZ pokrycie domu.
  ceiling: "{{ (p_max | int) + (total_home_load | int) }}"
  final_target: >
    {% if calculated_target > ceiling %}
      {{ ceiling }}
    {% else %}
      {{ calculated_target }}
    {% endif %}

trigger:
  # 1. HEARTBEAT (Bicie Serca i WygÅ‚adzanie) - co 2 minuty
  - platform: time_pattern
    minutes: "/2"
  # 2. Bezpieczny start po restarcie HA
  - platform: homeassistant
    event: start

action:
  # 0. OCHRONA (Safety Check) - Zatrzymanie przy braku komunikacji
  - if:
      - condition: template
        value_template: >
          {{ states(pv_power_ent) in ['unknown', 'unavailable', 'none'] or 
             states(max_sell_ent) in ['unknown', 'unavailable', 'none'] }}
    then:
      - stop: "BÅ‚Ä…d krytyczny: Brak komunikacji z falownikiem Deye. ModuÅ‚ zatrzymany."

  # GÅÃ“WNA LOGIKA DECYZYJNA SHADOW-PV
  - choose:
      # SCENARIUSZ 1: Bezpieczne okno czasowe i realna produkcja (>100W)
      - conditions:
          - condition: template
            value_template: "{{ is_safe_time == 'True' and total_pv > 100 }}"
        sequence:
          # A: WÅ‚Ä…czenie opcji eksportu (Solar Sell)
          - action: switch.turn_on
            target:
              entity_id: "{{ solar_sell_switch }}"
          
          # B: Dynamiczne ustawienie limitu Max Sell Power
          - action: number.set_value
            target:
              entity_id: "{{ max_sell_ent }}"
            data:
              value: "{{ final_target }}"

      # SCENARIUSZ 2: Poza bezpiecznym oknem LUB brak sÅ‚oÅ„ca (OdciÄ™cie eksportu)
      - conditions:
          - condition: template
            value_template: "{{ is_safe_time == 'False' or total_pv <= 100 }}"
        sequence:
          - action: number.set_value
            target:
              entity_id: "{{ max_sell_ent }}"
            data:
              value: 0
          - action: switch.turn_off
            target:
              entity_id: "{{ solar_sell_switch }}"
