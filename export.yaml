blueprint:
  name: "IntegraSoft Shadow-PV PRO v2.07 (PURE LEWA RÄ˜KA)"
  description: >
    ðŸš€ AUTOMATYKA HYBRYDOWA: IntegraSoft Shadow-PV PRO v2.07 ðŸš€
    
    v2.07: TWARDY STANDARD LEWA RÄ˜KA + "Å»ELAZNA REZERWA" + ZATRZASK TOU
           - CaÅ‚kowite usuniÄ™cie innych profili (OZE, SUN, Dashboard).
           - Wprowadzono suwak Å»elaznej Rezerwy SOC.
           - Logika atomowa: Na czas sprzedaÅ¼y automatyka wyÅ‚Ä…cza Time of Use w falowniku (switch.time_of_use), omijajÄ…c okienka. Po zakoÅ„czeniu sprzedaÅ¼y, TOU wraca na ON, a moc sprzedaÅ¼y na 0.
    v2.06: Zintegrowano MÃ³zg Alpha.
  domain: automation
  input:
    in_dev_prefix:
      name: "1. ðŸ”¹ Prefiks UrzÄ…dzenia"
      default: "deye_inverter"
    in_p_max:
      name: "2. ðŸ”´ ZgÅ‚oszona moc PV (Waty)"
      default: 6000
      selector: { number: { min: 1000, max: 50000, mode: box } }
    in_multiplier:
      name: "3. ðŸš€ MnoÅ¼nik AgresywnoÅ›ci (Szczyt RCE)"
      default: 1.50
      selector: { number: { min: 1.00, max: 2.50, step: 0.01, mode: box } }
    in_min_price:
      name: "4. ðŸ’° PrÃ³g opÅ‚acalnoÅ›ci RCE (zÅ‚)"
      default: 0.20
      selector: { number: { min: -1.00, max: 5.00, step: 0.01, mode: box } }
    in_min_soc_reserve:
      name: "5. ðŸ›¡ï¸ Å»elazna Rezerwa SOC (%)"
      description: "PoniÅ¼ej tego progu sprzedaÅ¼ z baterii jest blokowana, a Time of Use wraca do normy."
      default: 30
      selector: { number: { min: 10, max: 100, step: 1, mode: slider } }

mode: restart

variables:
  raw_prefix: !input in_dev_prefix
  prefix: "{{ raw_prefix | lower }}"
  p_max: !input in_p_max
  multiplier: !input in_multiplier
  min_price: !input in_min_price
  min_soc: !input in_min_soc_reserve
  
  # --- CZYSTE MAPOWANIE LEWA RÄ˜KA ---
  pv_power_ent: "sensor.{{ prefix }}_pv_power"
  gen_power_ent: "sensor.{{ prefix }}_generator_power_total"
  load_power_ent: "sensor.{{ prefix }}_load_power"
  grid_power_ent: "sensor.{{ prefix }}_grid_power"
  ct_power_ent: "sensor.{{ prefix }}_external_ct_power"
  max_sell_ent: "number.{{ prefix }}_max_sell_power"
  solar_sell_switch: "switch.{{ prefix }}_solar_sell"
  battery_soc_ent: "sensor.{{ prefix }}_battery_bms_soc"
  tou_switch_ent: "switch.{{ prefix }}_time_of_use"

  # --- Dane Systemowe ---
  current_soc: "{{ states(battery_soc_ent) | float(0) }}"
  total_pv: "{{ (states(pv_power_ent)|float(0)) + (states(gen_power_ent)|float(0)) }}"
  total_home_load: "{{ (states(load_power_ent)|float(0)) + ([0, (states(grid_power_ent)|float(0) - states(ct_power_ent)|float(0))]|max) }}"
  
  # --- MÃ³zg Alpha ---
  current_price: "{{ states('sensor.alpha_aktualna_cena_rce') | float(0) }}"
  is_expensive_window: "{{ states('sensor.alpha_plan_sprzedazy_5') == 'SprzedaÅ¼' }}"

  # --- Matryca BezpieczeÅ„stwa (12 miesiÄ™cy) ---
  is_safe_time: >
    {% set m, t = now().month, now().strftime('%H:%M') %}
    {% if m==1 %}{{ '08:00'<=t<='15:30' }}{% elif m==2 %}{{ '07:15'<=t<='16:30' }}{% elif m==3 %}{{ '06:15'<=t<='17:30' }}
    {% elif m==4 %}{{ '06:00'<=t<='19:30' }}{% elif m==5 %}{{ '05:00'<=t<='20:30' }}{% elif m==6 %}{{ '04:30'<=t<='21:00' }}
    {% elif m==7 %}{{ '04:45'<=t<='20:45' }}{% elif m==8 %}{{ '05:30'<=t<='20:00' }}{% elif m==9 %}{{ '06:15'<=t<='19:00' }}
    {% elif m==10 %}{{ '07:00'<=t<='17:30' }}{% elif m==11 %}{{ '07:15'<=t<='15:45' }}{% elif m==12 %}{{ '08:00'<=t<='15:00' }}
    {% else %}false{% endif %}

  # --- Kalkulacja Celu ---
  ceiling: "{{ (p_max|int) + (total_home_load|int) }}"
  cb_mod: "{{ 0.60 + (0.40 * ((now().minute % 15) / 15)) }}"
  
  # GÅ‚Ã³wna logika wyliczania mocy (uwzglÄ™dnia nowÄ… rezerwÄ™ SOC)
  final_target: >
    {% if is_safe_time == 'False' %} 0
    {% elif current_price < (min_price|float) %} 0
    {% elif current_soc <= (min_soc|float) %} 0
    {% elif current_soc >= 100 %} {{ ceiling }}
    {% elif is_expensive_window == 'True' %}
      {% if total_pv < 500 %} {{ [ceiling, (p_max * cb_mod + total_home_load)]|min|int }}
      {% else %} {{ [ceiling, (total_pv * multiplier + total_home_load)]|min|int }} {% endif %}
    {% else %}
      {{ [ceiling, (total_pv + total_home_load)]|min|int }}
    {% endif %}

trigger:
  - platform: time_pattern
    minutes: "/2"

action:
  - choose:
      # SCENARIUSZ 1: STOP SPRZEDAÅ»Y (SprzÄ…tanie i powrÃ³t TOU)
      - conditions: "{{ final_target == 0 }}"
        sequence:
          - action: number.set_value
            target: { entity_id: "{{ max_sell_ent }}" }
            data: { value: 0 }
          - action: switch.turn_off
            target: { entity_id: "{{ solar_sell_switch }}" }
          - action: switch.turn_on
            target: { entity_id: "{{ tou_switch_ent }}" }

      # SCENARIUSZ 2: AKTYWNA SPRZEDAÅ» (Bypass TOU)
      - conditions: "{{ final_target > 0 }}"
        sequence:
          - action: switch.turn_off
            target: { entity_id: "{{ tou_switch_ent }}" }
          - action: switch.turn_on
            target: { entity_id: "{{ solar_sell_switch }}" }
          - action: number.set_value
            target: { entity_id: "{{ max_sell_ent }}" }
            data: { value: "{{ final_target }}" }

# =========================================================
# ARCHIWUM ENCJI - LEWA RÄ˜KA (Kopia Zapasowa Profilu)
# Zgodnie z wytycznymi encje "Lewej RÄ™ki" pozostajÄ… w archiwum.
# - pv_power_ent: "sensor.deye_inverter_pv_power"
# - gen_power_ent: "sensor.deye_inverter_generator_power_total"
# - battery_soc_ent: "sensor.deye_inverter_battery_bms_soc"
# - load_power_ent: "sensor.deye_inverter_load_power"
# - max_sell_ent: "number.deye_inverter_max_sell_power"
# - solar_sell_switch: "switch.deye_inverter_solar_sell"
# - tou_switch_ent: "switch.deye_inverter_time_of_use"
# =========================================================
